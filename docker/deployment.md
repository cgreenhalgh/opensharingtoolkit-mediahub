# Mediahub Deployment

Notes on deployment...

The scope (mark 1):

- reproducible by others
- hosted service for initial research partners (SaaS)
- small number of users

## Docker

...with [docker](http://www.docker.com/).

The idea (mark 1):

- one container per user (or user group)
- container hosts complete system, i.e. couchdb, node-based commands
- container includes reverse http proxy enforcing access control
- multiple mediahub containers run behind a single public reverse proxy 

In terms of initial security and http request routing:

- public web interface requires external clients to use https, so all communication (including http basic authentication) is encrypted
- public web interface forwards to respective container based on top-level path
- internal requests are all http (not https)

- container reverse proxy requires http basic authentication for all 'sensitive' URLs (e.g. writes, non-public reads); this will have been passed through by the public proxy so entered by user/browser and externally transported over https

- couchdb is set up with admin, hubreader and hubwriter generic users and requires valid user
- reverse proxy inserts Http authentication header for relevant URLs (post its own basic authentication of external requests)

## Installing docker

Install docker as per [docker ubuntu install guide](https://docs.docker.com/installation/ubuntulinux/) - I am testing with 14.04, latest docker (currently 1.1.0).

## Just testing...

There is a docker image `nginxdev` and makefile target which is an nginx VM exposed on port `8080`, which serves content from `nginxdev/html`. This is intended for use in development, i.e. when running couchdb outside of the deployment framework of docker/nginx.

## Mediahub container

Runs:

- ubuntu 14.04 (aka `trusty`)
- nginx (1.4.6 from ubuntu `nginx`, or `stable` = 1.6.0 as of 2014-07-08 from  [nginx linux packages](http://nginx.org/en/linux_packages.html#stable))
- couchdb (1.5.0, ubuntu `couchdb`)
- node and npm (v0.10.25 and 1.3.10, respectively, ubuntu `npm`)
- PHP (just enough to run a couple of kiosk scripts)
- cfengine (3.6.0, [cfengine community distros](http://cfengine.com/cfengine-linux-distros/))
- (optionally) openssh-server

See [CFEngine in docker](https://cfengine.com/company/blog-detail/cfengine-and-docker-ensure-application-availability-and-container-integrity/) - for our purposes this is just a way of running several processes in one docker container.

Generic cfengine dockerfile is [`cfengine/Dockerfile`](cfengine/Dockerfile). Generic mediahub dockerfile is [`mediahub/Dockerfile`](mediahub/Dockerfile). Custom Dockerfile and other config is generated by the makefile in `mediahub-NAME` subdirectories:
```
make NAME=example run
```

This will download and build the mediahub source within the common `mediahub` image.

Each `mediahub-NAME` subdirectory includes `password`, the auto-generated password required to access that instance (username is instance name).

You should update the public-facing proxy configuration after running a new mediahub instance - see below (`make nginx`).

### Dealing with logs

Should probably make it run `logrotate`, but in the mean time you could ssh into it and
```
logrotate -v /home/root/opensharingtoolkit-mediahub/docker/mediahub/logrotate
```
These should probably rotate more often and keep fewer versions, aswell I think. Defaults are weekly, with 52 and 10 rotations, respectively.

### Update in place

For the baked version you can't SSH now. So an upgrade requires a new image and container. You might want to stop the current container to be safe...
```
sudo docker stop NAME
```
Make a temporary container with the same filesystem volumes, both to keep them live and to give a chance to tidy up:
```
sudo docker run -it --name NAME-up --volumes-from NAME -v $(pwd):/backup mediahub /bin/bash
(cd /var/log/nginx; tar zcf /backup/NAME-nginx-log.tgz *)
rm /var/log/nginx/*
(cd /usr/share/nginx/html; tar zcf /backup/NAME-html.tgz *)
```
Update the couchapp...
```
cd /home/root/opensharingtoolkit-mediahub
couchdb -b
sleep 10
make couchapplocal
wget -qO- --method=POST --header=Accept:application/json --header=Content-Type:application/json http://127.0.0.1:5984/mediahub/_ensure_full_commit 
couchdb -d
```
Remove old container
```
sudo docker rm NAME
```
Make and run new one (don't rely on Makefile run!! - that won't pull in the existing volumes)
```
make NAME=NAME image
sudo docker run -d --name NAME -h NAME --volumes-from NAME-up mediahub-NAME
```
Tidy up
```
sudo docker rm NAME-up
```


## Public web access

The common proxy front-end is build, run and updated by
```
make nginx
```

This will create proxy configs for each currently running mediahub container on the machine. These are configured with the current IP address of the container and assumes the internal firewall is sufficiently open for this to work.

### Deading with weblogs

The nginx container exposes the volume `/var/log`. To extract the logs do something to the effect of the below. Note that sig USR1 causes the nginx process to open fresh log files, so it isn't safe to do much with the old log files until after that. You could do something with logrotate but you won't be able to signal the real nginx process from within another container running logrotate.
```
DATE=`date -u +%F`
sudo docker run -i --volumes-from=nginx --rm ubuntu mkdir /var/log/nginx/${DATE}
sudo docker run -i --volumes-from=nginx --rm ubuntu mv /var/log/nginx/access.log /var/log/nginx/${DATE}/
sudo docker run -i --volumes-from=nginx --rm ubuntu mv /var/log/nginx/error.log /var/log/nginx/${DATE}/
sudo docker kill -s USR1 nginx
sleep 1
sudo docker run -i --volumes-from=nginx --rm ubuntu gzip /var/log/nginx/${DATE}/access.log
sudo docker run -i --volumes-from=nginx --rm ubuntu gzip /var/log/nginx/${DATE}/error.log
sudo docker run --volumes-from=nginx -v $(pwd):/backup --rm ubuntu tar cf /backup/${DATE}.logs.tar -C/var/log/nginx/${DATE} .
```
Optionally delete from container:
```
sudo docker run -i --volumes-from=nginx --rm ubuntu rm -rf /var/log/nginx/${DATE}
```

Or just generally poke around:
```
sudo docker run -it --volumes-from=nginx --rm ubuntu /bin/bash
```


## SSL certificate

[self-signed](http://httpd.apache.org/docs/2.2/ssl/ssl_faq.html#selfcert), for example. 
```
make nginx/server.key
```


